version: '3.8'
services:
  olca:
    build: .
    image: olca-ipc-server
    container_name: olca-ipc
    # 將 openLCA 資料夾掛到容器（範例），請依實際路徑調整
    # 把整個 TestPlatForm 掛到 /app/data，容器內會看到 /app/data/databases/mainTestDatabase
    volumes:
      - ./TestPlatForm:/app/data
      
    # 對外將容器的 8080 對應到主機 5011（與原始 run 範例一致）
    ports:
      - "5011:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 建議自動重啟，並指定要啟用的資料庫（與指令範例一致）
    command: -db newTestDatabase
    restart: unless-stopped

  flask:
    build: ./flask
    container_name: olca-flask
    ports:
      - "5010:5000" # 對外僅開放 Flask
    depends_on:
      - olca
    environment:
      # 讓 Flask 連到內部的 olca 服務
      OLCA_IPC_HOST: olca
      OLCA_IPC_PORT: "8080"
      IPC_CONNECT_RETRIES: "20"
      IPC_CONNECT_DELAY: "1.0"
    # 建議以 volume 掛載正在開發的 Flask 程式碼，方便修改立即生效
    # 為避免「將檔案掛到檔案」導致的 mount 錯誤，改用 env_file 讀取環境變數（或在生產中把 .env 包進 image）
    env_file:
      - ./flask/.env
    volumes:
      - ./flask/my_flask1.py:/app/my_flask1.py:ro
      - ./test_compare.html:/app/test_compare.html:ro
    restart: unless-stopped
